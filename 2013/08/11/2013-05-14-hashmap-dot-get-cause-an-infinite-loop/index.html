<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>HashMap.get()所导致的的死循环 | 盖世小虫</title>
  <meta name="author" content="SuetMing">
  
  <meta name="description" content="在以java为主导的web框架开发的APP，并发与多线程是经常出现的，若在高并发的API中用到了HashMap则可能诱发死循环">
  
  <meta name="keywords" content="hash,hashmap,infinite loop,死循环,DDOS,CPU 100%">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="HashMap.get()所导致的的死循环"/>
  <meta property="og:site_name" content="盖世小虫"/>

  
    <meta property="og:image" content="undefined"/>
  

  <meta name="ujianVerification" content="c7a5b14d01398b6bf2275703e3accf06" />
  
  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="盖世小虫" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40716915-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">盖世小虫</a></h1>
  <h2><a href="/">清静心性现，水清月影明</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
    <li><a href="/atom.xml">RSS</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-08-11T03:30:06.000Z"><a href="/2013/08/11/2013-05-14-hashmap-dot-get-cause-an-infinite-loop/">8月 11 2013</a></time>
      
      
  
    <h1 class="title">HashMap.get()所导致的的死循环</h1>
  

    </header>
    <div class="entry">
      
        <p>在以java为主导的web框架开发的APP，并发与多线程是经常出现的，若在高并发的API中用到了HashMap则可能诱发死循环</p>
<a name="more"></a>

<h2>症状</h2>
<ul>
<li>DDOS</li>
<li>CPU 100%</li>
<li>服务器访问速度异常缓慢</li>
</ul>
<h2>原因</h2>
<ul>
<li>HashMap并不是针对并发的根据Java Docs：</li>
</ul>
<blockquote>
<p><strong>Note that this implementation is not synchronized.</strong> If multiple threads access this map concurrently, and at least one of the threads modifies the map structurally, it must be synchronized externally. (A structural modification is any operation that adds or deletes one or more mappings; merely changing the value associated with a key that an instance already contains is not a structural modification.) This is typically accomplished by synchronizing on some object that naturally encapsulates the map.</p>
</blockquote>
<p>并发操作同一个HashMap就可能出现未知的诡异行为，而在调试中却又无法检测.</p>
<p>首先查看<strong>get()</strong>方法实现</p>
<figure class="highlight lang-java"><figcaption><span>old version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>
<span class="keyword">public</span> Object get(Object key) {
	Object k = maskNull(key);
	<span class="keyword">int</span> hash = hash(k);
	<span class="keyword">int</span> i = indexFor(hash, table.length);
	Entry e = table[i];
	<span class="keyword">while</span> (<span class="keyword">true</span>) {
		<span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">return</span> e;
		<span class="keyword">if</span> (e.hash == hash &amp;&amp; eq(k, e.key)) <span class="keyword">return</span> e.value;
		e = e.next;
	}
}
</pre></td></tr></table></figure>



<figure class="highlight lang-java"><figcaption><span>new version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre>
<span class="keyword">public</span> V get(Object key) {
    <span class="keyword">if</span> (key == <span class="keyword">null</span>)
        <span class="keyword">return</span> getForNullKey();
    <span class="keyword">int</span> hash = hash(key.hashCode());
    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[indexFor(hash, table.length)];
         e != <span class="keyword">null</span>;
         e = e.next) {
        Object k;
        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))
            <span class="keyword">return</span> e.value;
    }
    <span class="keyword">return</span> <span class="keyword">null</span>;
}
</pre></td></tr></table></figure>



<p>注意<strong>while(true)</strong>和<strong>for</strong>的e.next指向e, 这里就是出现问题的地方分配e.next的为：</p>
<figure class="highlight lang-java"><figcaption><span>old version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre>
<span class="keyword">void</span> transfer(Entry[] newTable) {
	Entry[] src = table;
	<span class="keyword">int</span> newCapacity = newTable.length;
	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; src.length; j++) {
		Entry e = src[j];
		<span class="keyword">if</span> (e != <span class="keyword">null</span>) {
			src[j] = <span class="keyword">null</span>;
			do {
				Entry next = e.next;
				<span class="keyword">int</span> i = indexFor(e.hash, newCapacity);
				e.next = newTable[i];
				newTable[i] = e;
				e = next;
			} <span class="keyword">while</span> (e != <span class="keyword">null</span>);
		}
	}
}

</pre></td></tr></table></figure>


<figure class="highlight lang-java"><figcaption><span>new version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre>
<span class="keyword">void</span> transfer(Entry[] newTable)
{
    Entry[] src = table;
    <span class="keyword">int</span> newCapacity = newTable.length;
    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; src.length; j++) {
        Entry&lt;K,V&gt; e = src[j];
        <span class="keyword">if</span> (e != <span class="keyword">null</span>) {
            src[j] = <span class="keyword">null</span>;
            do {
                Entry&lt;K,V&gt; next = e.next;
                <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);
                e.next = newTable[i];
                newTable[i] = e;
                e = next;
            } <span class="keyword">while</span> (e != <span class="keyword">null</span>);
        }
    }
}
</pre></td></tr></table></figure>


<h2>HashMap 原理</h2>
<p><img src="/images/photos/2013-05-14-hashmap.png" alt="HashMap 数据结构"></p>
<p>HashMap实现原理其实是一种“链表散列”的数据结构，通过hash算法将key散列，一个<key,value>存进来时，通过hash算出索引i，然后插入到指针数组table[i]中,如果不同的可以存入同一个table[i]中，则发生碰撞，即在table[i]处形成链表存储
如果table分配size为n，存入m个<key,value>，m 远远大于 n 则碰撞非常频繁，性能o(1)-&gt;o(n)，这是HashMap的不足，所以容量是HashMap的关键点，如果超过已知容量需要rehash，所有key的hash值会被重算</p>
<figure class="highlight lang-java"><figcaption><span>new version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="code"><pre>
<span class="keyword">public</span> V put(K key, V value) {
    <span class="comment">// HashMap允许存放null键和null值。</span>
    <span class="comment">// 当key为null时，调用putForNullKey方法，将value放置在数组第一个位置。</span>
    <span class="keyword">if</span> (key == <span class="keyword">null</span>)
        <span class="keyword">return</span> putForNullKey(value);
    <span class="comment">// 根据key的keyCode重新计算hash值。</span>
    <span class="keyword">int</span> hash = hash(key.hashCode());
    <span class="comment">// 搜索指定hash值在对应table中的索引。</span>
    <span class="keyword">int</span> i = indexFor(hash, table.length);
    <span class="comment">// 如果 i 索引处的 Entry 不为 null，通过循环不断遍历 e 元素的下一个元素。</span>
    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) {
        Object k;
        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) {
            V oldValue = e.value;
            e.value = value;
            e.recordAccess(<span class="keyword">this</span>);
            <span class="keyword">return</span> oldValue;
        }
    }
    <span class="comment">// 如果i索引处的Entry为null，表明此处还没有Entry。</span>
    modCount++;
    <span class="comment">// 将key、value添加到i索引处。</span>
    addEntry(hash, key, value, i);
    <span class="keyword">return</span> <span class="keyword">null</span>;
}

<span class="keyword">void</span> addEntry(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex) {
    <span class="comment">// 获取指定 bucketIndex 索引处的 Entry </span>
    Entry&lt;K,V&gt; e = table[bucketIndex];
    <span class="comment">// 将新创建的 Entry 放入 bucketIndex 索引处，并让新的 Entry 指向原来的 Entry</span>
    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;K,V&gt;(hash, key, value, e);
    <span class="comment">// 如果 Map 中的 key-value 对的数量超过了极限</span>
    <span class="keyword">if</span> (size++ &gt;= threshold)
    <span class="comment">// 把 table 对象的长度扩充到原来的2倍。</span>
        resize(<span class="number">2</span> * table.length);
}

<span class="keyword">void</span> resize(<span class="keyword">int</span> newCapacity) {
    Entry[] oldTable = table;
    <span class="keyword">int</span> oldCapacity = oldTable.length;
    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) {
        threshold = Integer.MAX_VALUE;
        <span class="keyword">return</span>;
    }

    Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity]; <span class="comment">// 新的容器空间</span>
    transfer(newTable); <span class="comment">// 复制数据过去</span>
    table = newTable;
    threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor); <span class="comment">// 重新计算threshold的值</span>
}
</pre></td></tr></table></figure>


<p>根据代码可以发现resize是耗时最大的
单线程下的resize，假设初始容量为1，hash算法为取余 mod 1，resize后hash算法为 mod 2，则如图所示</p>
<p><img src="/images/photos/2013-05-14-hashmap-resize.png" alt="one thread hashmap resize"></p>
<p>并发下的resize
注意transfer()的<code>Entry&lt;K,V&gt; next = e.next;</code>，若thread 1 运行到这行挂起，thread 2 开始执行，如图所示</p>
<p><img src="/images/photos/2013-05-14-hashmap-resize-two-thread.png" alt="two thread hashmap resize">
thread 2 resize完成后，thread 1 开始执行，此时执行</p>
<pre><code><figure class="highlight"><pre><span class="setting">newTalbe[i] = <span class="value">e;</span></span>
<span class="setting">e = <span class="value">next // 导致 e 指向key(<span class="number">1</span>)</span></span>
</pre></figure></code></pre>
<p>下一次循环</p>
<pre><code><figure class="highlight"><pre><span class="keyword">next</span>=e.<span class="keyword">next</span> /<span class="regexp">/ 导致 e 指向key(3)
</pre></figure></code></pre>
<p>thread 1 继续key(1)放入newTable[i]的第一个，然后 e 和 next 移动，死循环出现key(3).next指向了key(1)</p>
<p>此时调用HashTable.get(5)时死循环出现，CPU100%</p>
<p>若支持多线程HashMap，需要采用ConcurrentHashmap</p>
<h2>深化</h2>
<p>根据Hash算法的“非随机性”原理可以制造出N多的value不一样，但是key一样数据，然后让你的Hash表成为一张单向链表，而导致你的整个网站或是程序的运行性能以级数下降（可以很轻松的让你的CPU升到100%）这个问题出现的语言：</p>
<ul>
<li>java 所有版本</li>
<li>jruby &lt;= 1.6.5</li>
<li>php &lt;= 5.3.8, &lt;= 5.4.0RC3</li>
<li>python 所有版本</li>
<li>ruby 所有版本</li>
<li>V8 JavaScript Engine 所有版本</li>
</ul>
<p>部分框架：
- tomcat &lt;= 5.5.34, &lt;= 6.0.34, &lt;= 7.0.22 （目前fix在 5.5.35,  6.0.35,  7.0.23）
- jetty 所有版本</p>
<p>详细文章参见<a href="http://coolshell.cn/articles/6424.html">CoolShell</a></p>
<h2>深入阅读</h2>
<ul>
<li><a href="http://www.cs.rice.edu/~scrosby/hash/CrosbyWallach_UsenixSec2003.pdf">基于HashMap的DOS</a></li>
<li><a href="http://coolshell.cn/articles/6424.html">CoolShell:Hash Collision DoS</a></li>
</ul>

      
    </div>
    <footer>
      
        <strong style="text-color:#ff0000">转载本站文章请注明作者和出处 [盖世小虫-suetming.com],请勿用于任何商业目的</strong>
        
  
  <div class="categories">
    <a href="/categories/java/">java</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/DDOS/">DDOS</a>
  </div>

        <!--
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>
-->
        <a class="bshareDiv" href="http://www.bshare.cn/share">分享按钮</a><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#uuid=c55eb60c-b08a-4141-9020-2b3128ca0cc6&style=11&bp=qqmb,bsharesync,sinaminiblog,qzone,sohuminiblog,renren,xinhuamb,tianya,shouji,ifengmb,neteasemb,qqxiaoyou,kaixin001,peoplemb,baiduhi,douban,qqim"></script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<section id="comment">
	<h1 class="title">留言</h1>
	<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"suetmingessays"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- Duoshuo Comment END -->
</section>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:suetming.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/android/">android</a><small>2</small></li>
  
    <li><a href="/categories/java/">java</a><small>1</small></li>
  
    <li><a href="/categories/javascript/">javascript</a><small>3</small></li>
  
    <li><a href="/categories/octopress/">octopress</a><small>1</small></li>
  
    <li><a href="/categories/虚拟货币/">虚拟货币</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/DDOS/" style="font-size: 10.00px;">DDOS</a><a href="/tags/IO-performance/" style="font-size: 15.56px;">I/O performance</a><a href="/tags/Scrolling-performance/" style="font-size: 16.67px;">Scrolling performance</a><a href="/tags/UI-performance/" style="font-size: 14.44px;">UI performance</a><a href="/tags/free-bitcoin/" style="font-size: 11.11px;">free bitcoin</a><a href="/tags/javascript/" style="font-size: 13.33px;">javascript</a><a href="/tags/seo/" style="font-size: 17.78px;">seo</a><a href="/tags/历史记录/" style="font-size: 12.22px;">历史记录</a><a href="/tags/悬浮窗/" style="font-size: 18.89px;">悬浮窗</a>
  </div>
</div>


  <div class="widget tag">
<h3 class="title">友情链接</h3>
<ul class="entry">
<li><a href="http://worrydream.com/" title="Bret Victor">Bret Victor</a></li>
<li><a href="http://coolshell.cn/" title="酷壳">Cool Shell</a></li>
</ul>
</div>

  <div class="widget tag">
<h3 class="title">微信号</h3>
<img src="/images/photos/2013-08-11-code-weixin.png" alt="微信" width="100%" height="100%">
</div>

  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=1651218572&verifier=80fcc888&dpc=1"></iframe>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 SuetMing
  
</div>
<div class="clearfix"></div>
<!-- UJian Button BEGIN -->
<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&btn=4&fade=1&uid=1825970"></script>
<a href="http://www.ujian.cc" style="border:0;"><img src="http://img.ujian.cc/pixel.png" alt="友荐云推荐" style="border:0;padding:0;margin:0;" /></a>
<!-- UJian Button END -->

<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F5533780f373b71b5d7f93e710ff74bfc' type='text/javascript'%3E%3C/script%3E"));
</script>
</footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>