<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>HashMap.get()所导致的的死循环 | 盖世小虫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在以java为主导的web框架开发的APP，并发与多线程是经常出现的，若在高并发的API中用到了HashMap则可能诱发死循环">
<meta property="og:type" content="article">
<meta property="og:title" content="HashMap.get()所导致的的死循环">
<meta property="og:url" content="http://suetming.cn/2014/06/28/2013-05-14-hashmap-dot-get-cause-an-infinite-loop/">
<meta property="og:site_name" content="盖世小虫">
<meta property="og:description" content="在以java为主导的web框架开发的APP，并发与多线程是经常出现的，若在高并发的API中用到了HashMap则可能诱发死循环">
<meta property="og:image" content="/images/photos/2013-05-14-hashmap.png">
<meta property="og:image" content="/images/photos/2013-05-14-hashmap-resize.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HashMap.get()所导致的的死循环">
<meta name="twitter:description" content="在以java为主导的web框架开发的APP，并发与多线程是经常出现的，若在高并发的API中用到了HashMap则可能诱发死循环">
  
    <link rel="alternative" href="/atom.xml" title="盖世小虫" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="http://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">盖世小虫</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://suetming.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2013-05-14-hashmap-dot-get-cause-an-infinite-loop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/06/28/2013-05-14-hashmap-dot-get-cause-an-infinite-loop/" class="article-date">
  <time datetime="2014-06-28T05:59:17.000Z" itemprop="datePublished">6月 28 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      HashMap.get()所导致的的死循环
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在以java为主导的web框架开发的APP，并发与多线程是经常出现的，若在高并发的API中用到了HashMap则可能诱发死循环</p>
<a id="more"></a>

<h2 id="症状">症状</h2>
<ul>
<li>DDOS</li>
<li>CPU 100%</li>
<li>服务器访问速度异常缓慢</li>
</ul>
<h2 id="原因">原因</h2>
<ul>
<li>HashMap并不是针对并发的根据Java Docs：</li>
</ul>
<blockquote>
<p><strong>Note that this implementation is not synchronized.</strong> If multiple threads access this map concurrently, and at least one of the threads modifies the map structurally, it must be synchronized externally. (A structural modification is any operation that adds or deletes one or more mappings; merely changing the value associated with a key that an instance already contains is not a structural modification.) This is typically accomplished by synchronizing on some object that naturally encapsulates the map.</p>
</blockquote>
<p>并发操作同一个HashMap就可能出现未知的诡异行为，而在调试中却又无法检测.</p>
<p>首先查看<strong>get()</strong>方法实现</p>
<figure class="highlight java"><figcaption><span>old version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="keyword">public</span> Object <span class="title">get</span>(Object key) {
	Object k = maskNull(key);
	<span class="keyword">int</span> hash = hash(k);
	<span class="keyword">int</span> i = indexFor(hash, table.length);
	Entry e = table[i];
	<span class="keyword">while</span> (<span class="keyword">true</span>) {
		<span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">return</span> e;
		<span class="keyword">if</span> (e.hash == hash && eq(k, e.key)) <span class="keyword">return</span> e.value;
		e = e.next;
	}
}
</pre></td></tr></table></figure>


<figure class="highlight java"><figcaption><span>new version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="keyword">public</span> V <span class="title">get</span>(Object key) {
    <span class="keyword">if</span> (key == <span class="keyword">null</span>)
        <span class="keyword">return</span> getForNullKey();
    <span class="keyword">int</span> hash = hash(key.hashCode());
    <span class="keyword">for</span> (Entry<K,V> e = table[indexFor(hash, table.length)];
         e != <span class="keyword">null</span>;
         e = e.next) {
        Object k;
        <span class="keyword">if</span> (e.hash == hash && ((k = e.key) == key || key.equals(k)))
            <span class="keyword">return</span> e.value;
    }
    <span class="keyword">return</span> <span class="keyword">null</span>;
}
</pre></td></tr></table></figure>


<p>注意<strong>while(true)</strong>和<strong>for</strong>的e.next指向e, 这里就是出现问题的地方分配e.next的为：</p>
<figure class="highlight java"><figcaption><span>old version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="keyword">void</span> transfer(Entry[] newTable) {
	Entry[] src = table;
	<span class="keyword">int</span> newCapacity = newTable.length;
	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < src.length; j++) {
		Entry e = src[j];
		<span class="keyword">if</span> (e != <span class="keyword">null</span>) {
			src[j] = <span class="keyword">null</span>;
			do {
				Entry next = e.next;
				<span class="keyword">int</span> i = indexFor(e.hash, newCapacity);
				e.next = newTable[i];
				newTable[i] = e;
				e = next;
			} <span class="keyword">while</span> (e != <span class="keyword">null</span>);
		}
	}
}
</pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>new version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="keyword">void</span> transfer(Entry[] newTable)
{
    Entry[] src = table;
    <span class="keyword">int</span> newCapacity = newTable.length;
    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j < src.length; j++) {
        Entry<K,V> e = src[j];
        <span class="keyword">if</span> (e != <span class="keyword">null</span>) {
            src[j] = <span class="keyword">null</span>;
            do {
                Entry<K,V> next = e.next;
                <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);
                e.next = newTable[i];
                newTable[i] = e;
                e = next;
            } <span class="keyword">while</span> (e != <span class="keyword">null</span>);
        }
    }
}
</pre></td></tr></table></figure>

<h2 id="HashMap_原理">HashMap 原理</h2>
<p><img src="/images/photos/2013-05-14-hashmap.png" alt="HashMap 数据结构"></p>
<p>HashMap实现原理其实是一种“链表散列”的数据结构，通过hash算法将key散列，一个<key,value>存进来时，通过hash算出索引i，然后插入到指针数组table[i]中,如果不同的可以存入同一个table[i]中，则发生碰撞，即在table[i]处形成链表存储<br>如果table分配size为n，存入m个<key,value>，m 远远大于 n 则碰撞非常频繁，性能o(1)->o(n)，这是HashMap的不足，所以容量是HashMap的关键点，如果超过已知容量需要rehash，所有key的hash值会被重算</key,value></key,value></p>
<figure class="highlight java"><figcaption><span>new version </span></figcaption><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="code"><pre><span class="keyword">public</span> V <span class="title">put</span>(K key, V value) {
    <span class="comment">// HashMap允许存放null键和null值。</span>
    <span class="comment">// 当key为null时，调用putForNullKey方法，将value放置在数组第一个位置。</span>
    <span class="keyword">if</span> (key == <span class="keyword">null</span>)
        <span class="keyword">return</span> putForNullKey(value);
    <span class="comment">// 根据key的keyCode重新计算hash值。</span>
    <span class="keyword">int</span> hash = hash(key.hashCode());
    <span class="comment">// 搜索指定hash值在对应table中的索引。</span>
    <span class="keyword">int</span> i = indexFor(hash, table.length);
    <span class="comment">// 如果 i 索引处的 Entry 不为 null，通过循环不断遍历 e 元素的下一个元素。</span>
    <span class="keyword">for</span> (Entry<K,V> e = table[i]; e != <span class="keyword">null</span>; e = e.next) {
        Object k;
        <span class="keyword">if</span> (e.hash == hash && ((k = e.key) == key || key.equals(k))) {
            V oldValue = e.value;
            e.value = value;
            e.recordAccess(<span class="keyword">this</span>);
            <span class="keyword">return</span> oldValue;
        }
    }
    <span class="comment">// 如果i索引处的Entry为null，表明此处还没有Entry。</span>
    modCount++;
    <span class="comment">// 将key、value添加到i索引处。</span>
    addEntry(hash, key, value, i);
    <span class="keyword">return</span> <span class="keyword">null</span>;
}

<span class="keyword">void</span> addEntry(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex) {
    <span class="comment">// 获取指定 bucketIndex 索引处的 Entry </span>
    Entry<K,V> e = table[bucketIndex];
    <span class="comment">// 将新创建的 Entry 放入 bucketIndex 索引处，并让新的 Entry 指向原来的 Entry</span>
    table[bucketIndex] = <span class="keyword">new</span> Entry<K,V>(hash, key, value, e);
    <span class="comment">// 如果 Map 中的 key-value 对的数量超过了极限</span>
    <span class="keyword">if</span> (size++ >= threshold)
    <span class="comment">// 把 table 对象的长度扩充到原来的2倍。</span>
        resize(<span class="number">2</span> * table.length);
}

<span class="keyword">void</span> resize(<span class="keyword">int</span> newCapacity) {
    Entry[] oldTable = table;
    <span class="keyword">int</span> oldCapacity = oldTable.length;
    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) {
        threshold = Integer.MAX_VALUE;
        <span class="keyword">return</span>;
    }

    Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity]; <span class="comment">// 新的容器空间</span>
    transfer(newTable); <span class="comment">// 复制数据过去</span>
    table = newTable;
    threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor); <span class="comment">// 重新计算threshold的值</span>
}
</pre></td></tr></table></figure>

<p>根据代码可以发现resize是耗时最大的<br>单线程下的resize，假设初始容量为1，hash算法为取余 mod 1，resize后hash算法为 mod 2，则如图所示</p>
<p><img src="/images/photos/2013-05-14-hashmap-resize.png" alt="one thread hashmap resize"></p>
<p>并发下的resize<br>注意transfer()的<figure class="highlight Entry<K,V>"><figcaption><span>next = e.next; ```，若thread 1 运行到这行挂起，thread 2 开始执行，如图所示</span></figcaption><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>
![<span class="link_label">two thread hashmap resize</span>](<span class="link_url">/images/photos/2013-05-14-hashmap-resize-two-thread.png</span>)
thread 2 resize完成后，thread 1 开始执行，此时执行
</pre></td></tr></table></figure><br>newTalbe[i] = e;<br>e = next // 导致 e 指向key(1)</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>下一次循环
</pre></td></tr></table></figure><br>next=e.next // 导致 e 指向key(3)<br>```<br>thread 1 继续key(1)放入newTable[i]的第一个，然后 e 和 next 移动，死循环出现key(3).next指向了key(1)</p>
<p>此时调用HashTable.get(5)时死循环出现，CPU100%</p>
<p>若支持多线程HashMap，需要采用ConcurrentHashmap</p>
<h2 id="深化">深化</h2>
<p>根据Hash算法的“非随机性”原理可以制造出N多的value不一样，但是key一样数据，然后让你的Hash表成为一张单向链表，而导致你的整个网站或是程序的运行性能以级数下降（可以很轻松的让你的CPU升到100%）这个问题出现的语言：</p>
<ul>
<li>java 所有版本</li>
<li>jruby <= 1.6.5</li>
<li>php <= 5.3.8, <= 5.4.0RC3</li>
<li>python 所有版本</li>
<li>ruby 所有版本</li>
<li>V8 JavaScript Engine 所有版本</li>
</ul>
<p>部分框架：</p>
<ul>
<li>tomcat <= 5.5.34, <= 6.0.34, <= 7.0.22 （目前fix在 5.5.35,  6.0.35,  7.0.23）</li>
<li>jetty 所有版本</li>
</ul>
<p>详细文章参见<a href="http://coolshell.cn/articles/6424.html" target="_blank" rel="external">CoolShell</a></p>
<h2 id="深入阅读">深入阅读</h2>
<ul>
<li><a href="http://www.cs.rice.edu/~scrosby/hash/CrosbyWallach_UsenixSec2003.pdf" target="_blank" rel="external">基于HashMap的DOS</a></li>
<li><a href="http://coolshell.cn/articles/6424.html" target="_blank" rel="external">CoolShell:Hash Collision DoS</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://suetming.cn/2014/06/28/2013-05-14-hashmap-dot-get-cause-an-infinite-loop/" data-id="vwwodg8ld521o2f4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DDOS/">DDOS</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/06/28/2013-05-22-free-bitcoin/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          如果偷取别人的比特币
        
      </div>
    </a>
  
  
    <a href="/2014/06/28/2013-05-06-blog-with-octopress-01/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">octopress系列-从零搭建部署</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/deep-learning/">deep learning</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/octopress/">octopress</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟货币/">虚拟货币</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DDOS/">DDOS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Deep-Learning/">Deep Learning</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO-performance/">I/O performance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scrolling-performance/">Scrolling performance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI-performance/">UI performance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/custom-elements/">custom elements</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/decorator/">decorator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/free-bitcoin/">free bitcoin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/import/">import</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/seo/">seo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shadow-DOM/">shadow DOM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/templates/">templates</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/人脸检测/">人脸检测</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/历史记录/">历史记录</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/悬浮窗/">悬浮窗</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/DDOS/" style="font-size: NaNpx;">DDOS</a><a href="/tags/Deep-Learning/" style="font-size: NaNpx;">Deep Learning</a><a href="/tags/IO-performance/" style="font-size: NaNpx;">I/O performance</a><a href="/tags/Scrolling-performance/" style="font-size: NaNpx;">Scrolling performance</a><a href="/tags/UI-performance/" style="font-size: NaNpx;">UI performance</a><a href="/tags/custom-elements/" style="font-size: NaNpx;">custom elements</a><a href="/tags/decorator/" style="font-size: NaNpx;">decorator</a><a href="/tags/free-bitcoin/" style="font-size: NaNpx;">free bitcoin</a><a href="/tags/import/" style="font-size: NaNpx;">import</a><a href="/tags/javascript/" style="font-size: NaNpx;">javascript</a><a href="/tags/seo/" style="font-size: NaNpx;">seo</a><a href="/tags/shadow-DOM/" style="font-size: NaNpx;">shadow DOM</a><a href="/tags/templates/" style="font-size: NaNpx;">templates</a><a href="/tags/人脸检测/" style="font-size: NaNpx;">人脸检测</a><a href="/tags/历史记录/" style="font-size: NaNpx;">历史记录</a><a href="/tags/悬浮窗/" style="font-size: NaNpx;">悬浮窗</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07">七月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06">六月 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02">二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08">八月 2013</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/07/29/2013-06-29-web-components/">Web组件(Web Components) | HTML5</a>
          </li>
        
          <li>
            <a href="/2014/06/28/仿360chathead等app悬浮窗效果/">仿360|ChatHead等APP悬浮窗和动画效果</a>
          </li>
        
          <li>
            <a href="/2014/06/28/2013-07-13-android-performance/">android深度优化</a>
          </li>
        
          <li>
            <a href="/2014/06/28/2013-06-23-overwrite-global-methods/">重写全局方法 | JavaScript</a>
          </li>
        
          <li>
            <a href="/2014/06/28/2013-06-08-capture-back-menu-with-history-api/">利用history api截获返回事件</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 suetming<br>
      Powered by <a href="https://github.com/suetming" target="_blank">Suetming</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script type="text/javascript" src="/js/script.js"></script>
  </div>
</body>
</html>